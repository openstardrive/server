<html>
  <head>
    <title>OSD Server</title>
    <script src="jquery-2.2.0.min.js"></script>
    <script>
      var data;
      var apiBaseUrl = 'http://localhost:3000/api/';

      $.ajaxSetup({
        contentType: "application/json; charset=utf-8"
      });

      $.put = function (url, data) {
        return $.ajax({type: "PUT", url: url, contentType: "application/json", data: data});
      };

      $.delete = function (url) {
        return $.ajax({type: "DELETE", url: url});
      }

      function updatePage() {
        for (i = 0; i < data.systems.length; i++) {
          var system = data.systems[i];
          if (system.id.indexOf("engines") >= 0) {
            updateEngines(system);
          }
          if (system.id.indexOf("sensors") >= 0) {
            updateSensors(system);
          }
        }
      }

      function updateEngines(system) {
        $('#' + system.id + '-speed').html(system.speed.current + ' / ' + system.speed.max);
        var overheat = '';
        if (system.heat.secondsUntilOverheat != null) {
          var sec = system.heat.secondsUntilOverheat % 60;
          var min = Math.floor(system.heat.secondsUntilOverheat / 60);
          overheat = ' <strong> overheat in ' + min + ' minutes, ' + sec + ' seconds </strong>';
        }
        $('#' + system.id + '-heat').html(system.heat.current + ' / ' + system.heat.max + overheat);
      }

      function updateSensors(system) {
        var space = $('#contact-space');
        space.html('');
        system.contacts.forEach(function (item) {
          space.append('<div id="contact" style="background-color: blue; border-radius: 10px; width: 10px; height: 10px; position: relative; ' +
            'top: ' + item.position.y + 'px; left: ' + item.position.x + 'px;"></div>')
        });
        $('#contacts').html(JSON.stringify(system.contacts, null, 2));
      }

      function poll() {
        $.ajax(apiBaseUrl + 'state')
        .done(function (newData) {
          data = newData;
          updatePage();
        })
        .fail(function () {
          console.log(arguments);
        });
      }
      setInterval(poll, 1000);

      function getSystemById(id) {
        for (i = 0; i < data.systems.length; i++) {
          var system = data.systems[i];
          if (system.id == id) {
            return system;
          }
        }
        return null;
      }

      function increaseSpeed(id) {
        var system = getSystemById(id);
        var newSpeed = system.speed.current + 1;
        setSpeed(id, newSpeed);
      }

      function decreaseSpeed(id) {
        var system = getSystemById(id);
        var newSpeed = system.speed.current - 1;
        setSpeed(id, newSpeed);
      }

      function setSpeed(id, newSpeed) {
        var url = apiBaseUrl + 'systems/' + id + '/speed';
        $.post(url, JSON.stringify({value: newSpeed}), {dataType: 'json'})
          .done(function () {
            console.log('new speed', newSpeed, 'sent to system', id);
          })
          .fail(function () {
            console.log(arguments);
          });
      }

      function newContact() {
        var contact = {
          name: $('#contact-name').val(),
          position: {
            x: parseInt($('#contact-x').val(), 10),
            y: parseInt($('#contact-y').val(), 10)
          }
        };
        var url = apiBaseUrl + 'systems/sensors/contacts';
        $.post(url, JSON.stringify(contact))
          .done(function (data) {
            console.log('new contact created', data);
          })
          .fail(function () {
            console.log('failed to create contact', arguments)
          });
      }

      function findContact() {
        var name = $('#contact-name').val();
        var system = data.systems.find(function (system) {
          return system.id === 'sensors';
        });
        return system.contacts.find(function (contact) {
          return contact.name == name;
        });
      }

      function updateContact() {
        var contact = findContact();
        if (!contact) {
          console.log('Could not find contact to update');
          return;
        }
        contact.destinations.push({
          x: parseInt($('#contact-x').val(), 10),
          y: parseInt($('#contact-y').val(), 10),
          arriveInMilliseconds: parseInt($('#contact-seconds').val(), 10) * 1000
        });
        var url = apiBaseUrl + 'systems/sensors/contacts/' + contact.id;
        $.put(url, JSON.stringify(contact))
          .done(function (data) {
            console.log('contact updated');
          })
          .fail(function () {
            console.log('failed to update contact', arguments)
          });
      }

      function removeContact() {
        var contact = findContact();
        if (!contact) {
          console.log('Could not find contact to remove');
          return;
        }
        var url = apiBaseUrl + 'systems/sensors/contacts/' + contact.id;
        $.delete(url)
        .done(function (data) {
          console.log('contact deleted');
        })
        .fail(function () {
          console.log('failed to delete contact', arguments)
        });
      }
    </script>
  </head>
  <body>
    <div>
      <strong>FTL</strong>
      <div>
        Speed: <span id="ftl-engines-speed"></span>
        <button onClick="decreaseSpeed('ftl-engines')">-</button>
        <button onclick="increaseSpeed('ftl-engines')">+</button>
        <br/>
        Heat: <span id="ftl-engines-heat"></span><br/>
      </div>
    </div>

    <br/>
    <div>
      <strong>Sublight</strong>
      <div>
        Speed: <span id="sublight-engines-speed"></span>
        <button onClick="decreaseSpeed('sublight-engines')">-</button>
        <button onclick="increaseSpeed('sublight-engines')">+</button>
        <br/>
        Heat: <span id="sublight-engines-heat"></span><br/>
      </div>
    </div>

    <br/>
    <div>
      <strong>Sensors</strong>
      <div>
        Name: <input type="text" size="10" id="contact-name" />
        X: <input type="text" size="3" id="contact-x" />
        Y: <input type="text" size="3" id="contact-y" />
        Seconds: <input type="text" size="3" id="contact-seconds" />
        <button onClick="newContact()">New</button>
        <button onClick="updateContact()">Update</button>
        <button onClick="removeContact()">Remove</button>
      </div>
      Contacts:
      <div id="contact-space"></div>
      <pre id="contacts"></pre>
    </div>
  </body>
</html>
